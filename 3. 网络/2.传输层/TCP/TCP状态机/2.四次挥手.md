TCP 是全双工的，在断开连接时两端都需要发送 FIN 和 ACK。

### **第一次握手**

- 客户端认为数据发送完成，需要向服务端发送连接释放请求。
- 客户端发送结束标志位 `FIN=1` 和序号 `seq=u`
- 客户端进入 `FIN_WAIT` 状态


### **第二次握手**

- 服务器收到连接释放请求后，会告诉应用层要释放 TCP 链接
- 服务器发送确认标志位 `ACK=1`，确认号 `ack=u+1`， 序号 `seq=v`
- 进入 `CLOSE_WAIT`状态，表明客户端到服务器的连接已经释放，不再接收 A 发的数据了

### **第三次握手** 

- 如果此时还有没发完的数据会继续发送，完毕后会向 A 发送连接释放请求
- 服务器发送结束标志位 `FIN=1`，确认标志位 `ACK=1`，确认号 `ack=u+1`，序号`seq=w`
- 服务器进入 `LAST-ACK` 状态。

PS：通过延迟确认的技术（通常有时间限制，否则对方会误认为需要重传），可以将第二次和第三次握手合并，延迟 ACK 包的发送。

### **第四次握手**

- 客户端收到释放请求后，向服务器发送确认应答
- 客户端发送 确认标志位 `ACK=1`，确认号`ack=w+1` 序号`seq=u+1`
- 客户端进入 `TIME-WAIT` 状态。该状态会持续 2MSL（最大段生存期，指报文段在网络中生存的时间，超时会被抛弃） 时间，该时间段内服务端没有重发请求的话，就进入 `CLOSED` 状态。当服务端收到确认应答后，也便进入 CLOSED 状态。

### **为什么四次挥手**
- 三次握手时没有数据传输，服务端 SYN、ACK 可以同时传输，但是挥手时有数据传输，服务端 FIN、ACK 要分开传输
